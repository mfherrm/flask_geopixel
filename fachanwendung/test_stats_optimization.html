<!DOCTYPE html>
<html>
<head>
    <title>Cadenza Stats Optimization Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .info { color: blue; }
        .error { color: red; }
        button { padding: 10px 15px; margin: 5px; }
        #log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Cadenza Stats Optimization Test</h1>
    
    <div class="test-section">
        <h2>Test Description</h2>
        <p>This test verifies that:</p>
        <ul>
            <li>‚úÖ Periodic setInterval queries have been removed</li>
            <li>‚úÖ Stats are only updated when radio button is switched to Cadenza</li>
            <li>‚úÖ Stats are updated when geometry is added to database</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="testPeriodicQueries()">Test: Check for Periodic Queries</button>
        <button onclick="testRadioButtonTrigger()">Test: Radio Button Stats Trigger</button>
        <button onclick="testGeometryInsertion()">Test: Geometry Insertion Update</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testPeriodicQueries() {
            log('üîç Testing for periodic queries...', 'info');
            
            // Check if the setupPeriodicRefresh function still exists and is being called
            let hasPeriodicQueries = false;
            let intervalCount = 0;
            
            // Override setInterval to detect new intervals
            const originalSetInterval = window.setInterval;
            window.setInterval = function(callback, delay) {
                if (typeof callback === 'function' && delay <= 5000) {
                    intervalCount++;
                    log(`‚ö†Ô∏è Detected setInterval with ${delay}ms delay - checking if it's stats-related`, 'error');
                    
                    // Check if it's a stats-related interval
                    const callbackStr = callback.toString();
                    if (callbackStr.includes('refreshStatsTable') || 
                        callbackStr.includes('getCadenzaLayerStatistics') ||
                        callbackStr.includes('updateStatsTable')) {
                        hasPeriodicQueries = true;
                        log(`‚ùå FOUND PERIODIC STATS QUERY: ${callbackStr.substring(0, 100)}...`, 'error');
                    }
                }
                return originalSetInterval.call(this, callback, delay);
            };
            
            // Wait a moment and then check results
            setTimeout(() => {
                window.setInterval = originalSetInterval; // Restore original
                
                if (!hasPeriodicQueries) {
                    log('‚úÖ SUCCESS: No periodic stats queries detected!', 'success');
                } else {
                    log('‚ùå FAILURE: Periodic stats queries still exist!', 'error');
                }
                
                log(`üìä Total intervals detected: ${intervalCount}`, 'info');
            }, 1000);
        }

        function testRadioButtonTrigger() {
            log('üîç Testing radio button trigger mechanism...', 'info');
            
            // Check if the required functions exist
            const requiredFunctions = [
                'setCurrentViewMode',
                'getCadenzaLayerStatistics',
                'updateStatsTableForView'
            ];
            
            let allFunctionsExist = true;
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`‚úÖ Function ${funcName} exists`, 'success');
                } else {
                    log(`‚ùå Function ${funcName} missing!`, 'error');
                    allFunctionsExist = false;
                }
            });
            
            if (allFunctionsExist) {
                log('‚úÖ SUCCESS: All required functions for radio button trigger exist!', 'success');
                
                // Test the trigger mechanism
                try {
                    // Mock the radio button switch to Cadenza
                    log('üîÑ Simulating switch to Cadenza mode...', 'info');
                    
                    if (window.setCurrentViewMode) {
                        window.setCurrentViewMode('cadenza');
                        log('‚úÖ setCurrentViewMode("cadenza") called successfully', 'success');
                    }
                    
                } catch (error) {
                    log(`‚ùå Error testing radio button trigger: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå FAILURE: Missing required functions for radio button trigger!', 'error');
            }
        }

        function testGeometryInsertion() {
            log('üîç Testing geometry insertion stats update...', 'info');
            
            // Check if the updateCachedCadenzaStats function exists
            if (typeof window.updateCachedCadenzaStats === 'function') {
                log('‚úÖ updateCachedCadenzaStats function exists', 'success');
            } else {
                log('‚ÑπÔ∏è updateCachedCadenzaStats is internal function (this is expected)', 'info');
            }
            
            // Check if updateStatsTable function exists
            if (typeof window.updateStatsTable === 'function') {
                log('‚úÖ updateStatsTable function exists', 'success');
            } else if (typeof window.refreshStatsTable === 'function') {
                log('‚úÖ refreshStatsTable function exists', 'success');
            } else {
                log('‚ùå No stats update function found!', 'error');
                return;
            }
            
            log('‚úÖ SUCCESS: Geometry insertion update mechanism appears to be in place', 'success');
            log('‚ÑπÔ∏è Actual testing requires backend /insert_geometry endpoint', 'info');
        }

        // Initial test on page load
        window.addEventListener('load', () => {
            log('üöÄ Cadenza Stats Optimization Test Started', 'info');
            log('‚ÑπÔ∏è This test verifies the optimization changes are working correctly', 'info');
            setTimeout(testPeriodicQueries, 500);
        });
    </script>
</body>
</html>